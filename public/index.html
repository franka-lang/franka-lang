<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Franka Module Browser</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f5f5f5;
        }

        #root {
            min-height: 100vh;
        }

        .app {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            margin: -20px -20px 20px -20px;
            border-radius: 0 0 8px 8px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            color: #bdc3c7;
            font-size: 14px;
        }

        .breadcrumb {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .breadcrumb a {
            color: #3498db;
            text-decoration: none;
            margin-right: 5px;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .breadcrumb span {
            color: #7f8c8d;
            margin: 0 5px;
        }

        .directory-list {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .directory-item {
            padding: 15px 20px;
            border-bottom: 1px solid #ecf0f1;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
        }

        .directory-item:hover {
            background-color: #f8f9fa;
        }

        .directory-item:last-child {
            border-bottom: none;
        }

        .directory-item.disabled {
            cursor: default;
            opacity: 0.5;
        }

        .directory-item.disabled:hover {
            background-color: white;
        }

        .item-icon {
            margin-right: 12px;
            font-size: 20px;
        }

        .item-name {
            font-weight: 500;
            color: #2c3e50;
        }

        .module-view {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 30px;
        }

        .module-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #ecf0f1;
        }

        .module-header h2 {
            color: #2c3e50;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .module-header .description {
            color: #7f8c8d;
            font-size: 16px;
        }

        .function-section {
            margin-bottom: 30px;
        }

        .function-card {
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: #fafafa;
        }

        .function-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .function-name {
            font-size: 22px;
            font-weight: 600;
            color: #2c3e50;
        }

        .function-description {
            color: #7f8c8d;
            margin-bottom: 15px;
            font-style: italic;
        }

        .function-details {
            background: white;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .function-details h4 {
            color: #34495e;
            font-size: 14px;
            text-transform: uppercase;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .logic-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .verification-grid {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            margin-top: 10px;
        }

        .verification-grid th {
            background: #3498db;
            color: white;
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            border: 1px solid #2980b9;
        }

        .verification-grid td {
            padding: 10px;
            border: 1px solid #e0e0e0;
            background: white;
        }

        .verification-grid tr:nth-child(even) td {
            background: #f9f9f9;
        }

        .verification-grid tr:hover td {
            background: #e3f2fd;
        }

        .verification-grid .function-name-cell {
            font-weight: 600;
            color: #2c3e50;
        }

        .verification-grid .test-value {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #2c3e50;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .verification-grid .status-passed {
            color: #27ae60;
            font-weight: 600;
            text-align: center;
        }

        .verification-grid .status-failed {
            color: #e74c3c;
            font-weight: 600;
            text-align: center;
        }

        .verification-grid .status-icon {
            font-size: 18px;
        }

        .no-tests {
            color: #95a5a6;
            font-style: italic;
            padding: 15px;
            text-align: center;
            background: #ecf0f1;
            border-radius: 6px;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .back-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }

        .back-button:hover {
            background: #2980b9;
        }

        /* Tree visualization styles */
        .expression-tree {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            background: white;
            padding: 15px;
            border-radius: 6px;
            text-align: left;
        }

        .tree-node {
            margin: 4px 0;
            display: flex;
            align-items: flex-start;
        }

        .tree-connector {
            color: #95a5a6;
            margin-right: 5px;
            flex-shrink: 0;
        }

        .tree-icon {
            margin-right: 5px;
            flex-shrink: 0;
        }

        .tree-label {
            color: #8e44ad;
            font-weight: 600;
            margin-right: 5px;
        }

        .tree-content {
            color: #2c3e50;
            flex: 1;
        }

        .tree-children {
            margin-left: 20px;
            border-left: 2px solid #ecf0f1;
            padding-left: 10px;
        }

        .literal {
            color: #27ae60;
            font-weight: 500;
        }

        .string-literal {
            color: #e67e22;
        }

        .number-literal {
            color: #3498db;
        }

        .bool-literal {
            color: #9b59b6;
        }

        .variable {
            color: #2980b9;
            font-weight: 500;
        }

        .operation {
            color: #c0392b;
            font-weight: 600;
        }

        .keyword {
            color: #8e44ad;
            font-weight: 600;
        }

        .tree-line {
            margin: 2px 0;
        }

        .nested-structure {
            margin-left: 15px;
            padding-left: 10px;
            border-left: 2px solid #3498db;
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="app">
            <div class="header">
                <h1>üîß Franka Module Browser</h1>
                <p>Browse and explore Franka modules and their test cases</p>
            </div>
            <div id="content" class="loading">Loading...</div>
        </div>
    </div>

    <script>
        // State management
        let state = {
            currentPath: '',
            view: 'directory',
            directoryData: null,
            moduleData: null,
            loading: true,
            error: null
        };

        // Utility function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Format values for display
        function formatValue(value) {
            if (typeof value === 'object' && value !== null) {
                return JSON.stringify(value, null, 2);
            }
            return String(value);
        }

        // Render expression as a tree-like HTML structure
        function renderExpressionTree(expr, indent = 0) {
            if (expr === null || expr === undefined) {
                return '<span class="literal">null</span>';
            }

            // Handle primitives (strings, numbers, booleans)
            if (typeof expr === 'string') {
                return `<span class="literal string-literal">"${escapeHtml(expr)}"</span>`;
            }
            if (typeof expr === 'number') {
                return `<span class="literal number-literal">${expr}</span>`;
            }
            if (typeof expr === 'boolean') {
                return `<span class="literal bool-literal">${expr}</span>`;
            }

            // Handle arrays
            if (Array.isArray(expr)) {
                if (expr.length === 0) {
                    return '<span class="literal">[]</span>';
                }
                let html = '<div class="tree-children">';
                expr.forEach((item, index) => {
                    html += '<div class="tree-node">';
                    html += `<span class="tree-connector">${index === expr.length - 1 ? '‚îî‚îÄ' : '‚îú‚îÄ'}</span>`;
                    html += `<span class="tree-label">[${index}]:</span> `;
                    html += renderExpressionTree(item, indent + 1);
                    html += '</div>';
                });
                html += '</div>';
                return html;
            }

            // Handle objects
            if (typeof expr === 'object') {
                const keys = Object.keys(expr);
                if (keys.length === 0) {
                    return '<span class="literal">{}</span>';
                }

                // Special handling for specific operations
                if (keys.length === 1) {
                    const key = keys[0];
                    const value = expr[key];

                    // Handle 'get' operation
                    if (key === 'get') {
                        return `<span class="keyword">get</span> <span class="variable">${escapeHtml(value)}</span>`;
                    }

                    // Handle 'let/in' structure
                    if (key === 'let' && typeof value === 'object' && !Array.isArray(value)) {
                        let html = '<div class="tree-node"><span class="keyword">let</span></div>';
                        html += '<div class="nested-structure">';
                        Object.entries(value).forEach(([bindName, bindValue], index, arr) => {
                            html += '<div class="tree-line">';
                            html += `<span class="tree-connector">${index === arr.length - 1 ? '‚îî‚îÄ' : '‚îú‚îÄ'}</span>`;
                            html += `<span class="variable">${escapeHtml(bindName)}</span> = `;
                            html += renderExpressionTree(bindValue, indent + 1);
                            html += '</div>';
                        });
                        html += '</div>';
                        return html;
                    }

                    if (key === 'in') {
                        let html = '<div class="tree-node"><span class="keyword">in</span></div>';
                        html += '<div class="nested-structure">';
                        html += renderExpressionTree(value, indent + 1);
                        html += '</div>';
                        return html;
                    }

                    // Handle 'if/then/else' structure
                    if (key === 'if') {
                        let html = '<div class="tree-node">';
                        html += '<span class="tree-icon">üîÄ</span>';
                        html += '<span class="keyword">if</span> ';
                        html += renderExpressionTree(value, indent + 1);
                        html += '</div>';
                        return html;
                    }

                    if (key === 'then') {
                        let html = '<div class="tree-node">';
                        html += '<span class="tree-connector">‚îú‚îÄ</span>';
                        html += '<span class="tree-icon">‚úì</span>';
                        html += '<span class="keyword">then:</span>';
                        html += '</div>';
                        html += '<div class="nested-structure">';
                        html += renderExpressionTree(value, indent + 1);
                        html += '</div>';
                        return html;
                    }

                    if (key === 'else') {
                        let html = '<div class="tree-node">';
                        html += '<span class="tree-connector">‚îî‚îÄ</span>';
                        html += '<span class="tree-icon">‚úó</span>';
                        html += '<span class="keyword">else:</span>';
                        html += '</div>';
                        html += '<div class="nested-structure">';
                        html += renderExpressionTree(value, indent + 1);
                        html += '</div>';
                        return html;
                    }

                    // Handle operations with single arguments
                    if (['uppercase', 'lowercase', 'not'].includes(key)) {
                        let html = '<span class="operation">' + escapeHtml(key) + '</span>(';
                        html += renderExpressionTree(value, indent);
                        html += ')';
                        return html;
                    }
                }

                // Handle binary operations
                if (keys.includes('left') && keys.includes('right')) {
                    const operation = keys.find(k => k !== 'left' && k !== 'right');
                    if (operation) {
                        let html = '<div class="tree-node">';
                        html += `<span class="tree-icon">‚ö°</span>`;
                        html += `<span class="operation">${escapeHtml(operation)}</span>`;
                        html += '</div>';
                        html += '<div class="nested-structure">';
                        html += '<div class="tree-line">';
                        html += '<span class="tree-connector">‚îú‚îÄ</span>';
                        html += '<span class="tree-label">left:</span> ';
                        html += renderExpressionTree(expr.left, indent + 1);
                        html += '</div>';
                        html += '<div class="tree-line">';
                        html += '<span class="tree-connector">‚îî‚îÄ</span>';
                        html += '<span class="tree-label">right:</span> ';
                        html += renderExpressionTree(expr.right, indent + 1);
                        html += '</div>';
                        html += '</div>';
                        return html;
                    }
                }

                // Handle concat operation
                if (keys.length === 1 && keys[0] === 'concat' && Array.isArray(expr.concat)) {
                    let html = '<div class="tree-node">';
                    html += '<span class="tree-icon">üîó</span>';
                    html += '<span class="operation">concat</span>';
                    html += '</div>';
                    html += '<div class="nested-structure">';
                    expr.concat.forEach((item, index) => {
                        html += '<div class="tree-line">';
                        html += `<span class="tree-connector">${index === expr.concat.length - 1 ? '‚îî‚îÄ' : '‚îú‚îÄ'}</span>`;
                        html += renderExpressionTree(item, indent + 1);
                        html += '</div>';
                    });
                    html += '</div>';
                    return html;
                }

                // Generic object rendering
                let html = '<div class="tree-children">';
                keys.forEach((key, index) => {
                    html += '<div class="tree-line">';
                    html += `<span class="tree-connector">${index === keys.length - 1 ? '‚îî‚îÄ' : '‚îú‚îÄ'}</span>`;
                    html += `<span class="tree-label">${escapeHtml(key)}:</span> `;
                    html += renderExpressionTree(expr[key], indent + 1);
                    html += '</div>';
                });
                html += '</div>';
                return html;
            }

            return escapeHtml(String(expr));
        }

        // Render functions
        function render() {
            const content = document.getElementById('content');
            
            if (state.view === 'directory') {
                renderDirectory(content);
            } else if (state.view === 'module') {
                renderModule(content);
            }
        }

        function renderDirectory(container) {
            if (state.loading) {
                container.innerHTML = '<div class="loading">Loading directory...</div>';
                return;
            }

            if (state.error) {
                container.innerHTML = `<div class="error">Error: ${escapeHtml(state.error)}</div>`;
                return;
            }

            if (!state.directoryData) {
                return;
            }

            const pathParts = state.currentPath ? state.currentPath.split('/').filter(Boolean) : [];
            
            let breadcrumbHtml = '<div class="breadcrumb">';
            breadcrumbHtml += '<a href="#" data-path="">üè† Home</a>';
            pathParts.forEach((part, index) => {
                const path = pathParts.slice(0, index + 1).join('/');
                breadcrumbHtml += `<span>/</span><a href="#" data-path="${escapeHtml(path)}">${escapeHtml(part)}</a>`;
            });
            breadcrumbHtml += '</div>';

            let listHtml = '<div class="directory-list">';
            if (state.directoryData.entries.length === 0) {
                listHtml += '<div class="directory-item disabled"><span class="item-name">No modules or directories found</span></div>';
            } else {
                state.directoryData.entries.forEach(item => {
                    const icon = item.type === 'directory' ? 'üìÅ' : 'üìÑ';
                    listHtml += `<div class="directory-item" data-type="${item.type}" data-path="${escapeHtml(item.path)}">`;
                    listHtml += `<span class="item-icon">${icon}</span>`;
                    listHtml += `<span class="item-name">${escapeHtml(item.name)}</span>`;
                    listHtml += '</div>';
                });
            }
            listHtml += '</div>';

            container.innerHTML = breadcrumbHtml + listHtml;

            // Add event listeners
            container.querySelectorAll('.breadcrumb a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const path = e.target.dataset.path;
                    navigateTo(path);
                });
            });

            container.querySelectorAll('.directory-item:not(.disabled)').forEach(item => {
                item.addEventListener('click', () => {
                    const type = item.dataset.type;
                    const path = item.dataset.path;
                    if (type === 'directory') {
                        navigateTo(path);
                    } else if (type === 'file') {
                        loadModule(path);
                    }
                });
            });
        }

        function renderModule(container) {
            if (state.loading) {
                container.innerHTML = '<div class="loading">Loading module...</div>';
                return;
            }

            if (state.error) {
                const html = `
                    <button class="back-button" onclick="backToDirectory()">‚Üê Back to Directory</button>
                    <div class="error">Error: ${escapeHtml(state.error)}</div>
                `;
                container.innerHTML = html;
                return;
            }

            if (!state.moduleData) {
                return;
            }

            const { module, specs } = state.moduleData;

            let html = '<button class="back-button" onclick="backToDirectory()">‚Üê Back to Directory</button>';
            html += '<div class="module-view">';
            html += '<div class="module-header">';
            html += `<h2>${escapeHtml(module.module.name)}</h2>`;
            if (module.module.description) {
                html += `<p class="description">${escapeHtml(module.module.description)}</p>`;
            }
            html += '</div>';

            html += '<div class="function-section"><h3>Functions</h3>';
            Object.entries(module.functions).forEach(([funcName, funcDef]) => {
                html += renderFunctionCard(funcName, funcDef, specs, state.moduleData.testResults);
            });
            html += '</div>';

            html += '</div>';

            container.innerHTML = html;
        }

        function renderFunctionCard(name, func, specs, testResults) {
            let html = '<div class="function-card">';
            html += '<div class="function-header">';
            html += `<div class="function-name">‚öôÔ∏è ${escapeHtml(name)}</div>`;
            html += '</div>';

            if (func.description) {
                html += `<div class="function-description">${escapeHtml(func.description)}</div>`;
            }

            html += '<div class="function-details">';
            html += '<h4>Logic</h4>';
            html += `<div class="expression-tree">${renderExpressionTree(func.logic)}</div>`;
            html += '</div>';

            if (func.input) {
                html += '<div class="function-details">';
                html += '<h4>Input Parameters</h4>';
                html += `<div class="expression-tree">${renderExpressionTree(func.input)}</div>`;
                html += '</div>';
            }

            if (func.output) {
                html += '<div class="function-details">';
                html += '<h4>Output</h4>';
                html += `<div class="expression-tree">${renderExpressionTree(func.output)}</div>`;
                html += '</div>';
            }

            // Add verification section for this function
            html += renderFunctionVerification(name, func, specs, testResults);

            html += '</div>';
            return html;
        }

        function renderFunctionVerification(funcName, func, specs, testResults) {
            const tests = specs?.functions?.[funcName]?.tests || [];
            const results = testResults?.[funcName] || [];

            if (tests.length === 0) {
                return '<div class="function-details"><h4>Verification</h4><div class="no-tests">No test cases defined</div></div>';
            }

            let html = '<div class="function-details">';
            html += '<h4>üîç Verification</h4>';
            
            // Collect input parameter names and output names for this function
            const inputParams = func.input ? Object.keys(func.input) : [];
            const outputNames = [];
            
            if (func.output && typeof func.output === 'object' && !Array.isArray(func.output)) {
                outputNames.push(...Object.keys(func.output));
            } else {
                outputNames.push('output');
            }

            // Build the table
            html += '<table class="verification-grid">';
            html += '<thead><tr>';
            html += '<th>Test Description</th>';
            
            // Add columns for each input parameter
            inputParams.forEach(param => {
                html += `<th>Input: ${escapeHtml(param)}</th>`;
            });
            
            // Add columns for outputs
            if (outputNames.length === 1 && outputNames[0] === 'output') {
                html += '<th>Expected Output</th>';
            } else {
                outputNames.forEach(out => {
                    html += `<th>Expected: ${escapeHtml(out)}</th>`;
                });
            }
            
            html += '<th>Status</th>';
            html += '</tr></thead>';
            html += '<tbody>';

            // Add rows for each test case
            tests.forEach((test, testIndex) => {
                const result = results[testIndex] || { passed: false };
                
                html += '<tr>';
                html += `<td>${escapeHtml(test.description || `Test ${testIndex + 1}`)}</td>`;
                
                // Add input parameter values
                inputParams.forEach(param => {
                    const value = test.input?.[param];
                    if (value !== undefined) {
                        html += `<td class="test-value" title="${escapeHtml(formatValue(value))}">${escapeHtml(formatValue(value))}</td>`;
                    } else {
                        html += '<td class="test-value">-</td>';
                    }
                });
                
                // Add expected output values
                if (typeof test.expectedOutput === 'object' && test.expectedOutput !== null && !Array.isArray(test.expectedOutput)) {
                    outputNames.forEach(out => {
                        const value = test.expectedOutput[out];
                        if (value !== undefined) {
                            html += `<td class="test-value" title="${escapeHtml(formatValue(value))}">${escapeHtml(formatValue(value))}</td>`;
                        } else {
                            html += '<td class="test-value">-</td>';
                        }
                    });
                } else {
                    html += `<td class="test-value" title="${escapeHtml(formatValue(test.expectedOutput))}">${escapeHtml(formatValue(test.expectedOutput))}</td>`;
                    // Fill remaining output columns if any
                    for (let i = 1; i < outputNames.length; i++) {
                        html += '<td class="test-value">-</td>';
                    }
                }
                
                // Add status
                if (result.passed) {
                    html += '<td class="status-passed"><span class="status-icon">‚úì</span> Passed</td>';
                } else {
                    html += '<td class="status-failed"><span class="status-icon">‚úó</span> Failed</td>';
                }
                
                html += '</tr>';
            });

            html += '</tbody></table>';
            html += '</div>';
            return html;
        }

        // API functions
        async function loadDirectory(path) {
            state.loading = true;
            state.error = null;
            render();

            try {
                const response = await fetch(`/api/browse?path=${encodeURIComponent(path)}`);
                if (!response.ok) {
                    throw new Error('Failed to load directory');
                }
                state.directoryData = await response.json();
            } catch (err) {
                state.error = err.message;
            } finally {
                state.loading = false;
                render();
            }
        }

        async function loadModule(path) {
            state.loading = true;
            state.error = null;
            state.view = 'module';
            render();

            try {
                const response = await fetch(`/api/module?path=${encodeURIComponent(path)}`);
                if (!response.ok) {
                    throw new Error('Failed to load module');
                }
                state.moduleData = await response.json();
            } catch (err) {
                state.error = err.message;
            } finally {
                state.loading = false;
                render();
            }
        }

        function navigateTo(path) {
            state.currentPath = path;
            state.view = 'directory';
            loadDirectory(path);
        }

        function backToDirectory() {
            state.view = 'directory';
            state.moduleData = null;
            render();
        }

        // Initialize
        loadDirectory('');
    </script>
</body>
</html>
