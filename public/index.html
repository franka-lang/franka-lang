<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Franka Module Browser</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f5f5f5;
        }

        #root {
            min-height: 100vh;
        }

        .app {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            margin: -20px -20px 20px -20px;
            border-radius: 0 0 8px 8px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            color: #bdc3c7;
            font-size: 14px;
        }

        .breadcrumb {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .breadcrumb a {
            color: #3498db;
            text-decoration: none;
            margin-right: 5px;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .breadcrumb span {
            color: #7f8c8d;
            margin: 0 5px;
        }

        .directory-list {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .directory-item {
            padding: 15px 20px;
            border-bottom: 1px solid #ecf0f1;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
        }

        .directory-item:hover {
            background-color: #f8f9fa;
        }

        .directory-item:last-child {
            border-bottom: none;
        }

        .directory-item.disabled {
            cursor: default;
            opacity: 0.5;
        }

        .directory-item.disabled:hover {
            background-color: white;
        }

        .item-icon {
            margin-right: 12px;
            font-size: 20px;
        }

        .item-name {
            font-weight: 500;
            color: #2c3e50;
        }

        .module-view {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 30px;
        }

        .module-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #ecf0f1;
        }

        .module-header h2 {
            color: #2c3e50;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .module-header .description {
            color: #7f8c8d;
            font-size: 16px;
        }

        .function-section {
            margin-bottom: 30px;
        }

        .function-card {
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: #fafafa;
        }

        .function-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .function-name {
            font-size: 22px;
            font-weight: 600;
            color: #2c3e50;
        }

        .function-description {
            color: #7f8c8d;
            margin-bottom: 15px;
            font-style: italic;
        }

        .io-container {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 20px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            border: 2px solid #3498db;
        }

        .io-section {
            flex: 1;
        }

        .io-section h4 {
            color: #34495e;
            font-size: 14px;
            text-transform: uppercase;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .io-arrow {
            font-size: 32px;
            color: #3498db;
            font-weight: bold;
            display: flex;
            align-items: center;
            padding-top: 30px;
        }

        .io-grid {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .io-grid thead {
            background-color: #ecf0f1;
        }

        .io-grid th {
            text-align: left;
            padding: 10px;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #bdc3c7;
        }

        .io-grid td {
            padding: 10px;
            border-bottom: 1px solid #ecf0f1;
            text-align: left;
        }

        .io-grid tbody tr:last-child td {
            border-bottom: none;
        }

        .io-grid tbody tr:hover {
            background-color: #f8f9fa;
        }

        .param-name {
            color: #2980b9;
            font-weight: 500;
            font-family: 'Courier New', monospace;
        }

        .param-type {
            color: #27ae60;
            font-family: 'Courier New', monospace;
        }

        .param-default {
            color: #e67e22;
            font-family: 'Courier New', monospace;
        }

        .not-declared {
            color: #95a5a6;
            font-style: italic;
            padding: 15px;
            text-align: center;
            background: #ecf0f1;
            border-radius: 6px;
        }

        .function-details {
            background: white;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .function-details h4 {
            color: #34495e;
            font-size: 14px;
            text-transform: uppercase;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .logic-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .verification-section {
            margin-top: 15px;
        }

        .verification-section h4 {
            color: #34495e;
            font-size: 14px;
            text-transform: uppercase;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .verification-grid-container {
            background: white;
            border-radius: 6px;
            overflow-x: auto;
        }

        .verification-grid {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .verification-grid thead {
            background-color: #34495e;
            color: white;
        }

        .verification-grid th {
            text-align: left;
            padding: 12px 15px;
            font-weight: 600;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .verification-grid th:last-child {
            border-right: none;
        }

        .verification-grid td {
            padding: 12px 15px;
            border-bottom: 1px solid #ecf0f1;
            border-right: 1px solid #ecf0f1;
            text-align: left;
            vertical-align: middle;
        }

        .verification-grid td:last-child {
            border-right: none;
        }

        .verification-grid tbody tr:last-child td {
            border-bottom: none;
        }

        .verification-grid tbody tr:hover {
            background-color: #f8f9fa;
        }

        .verify-desc-col {
            min-width: 200px;
        }

        .verify-input-col {
            background-color: #3498db !important;
            min-width: 120px;
        }

        .verify-output-col {
            background-color: #27ae60 !important;
            min-width: 120px;
        }

        .verify-status-col {
            background-color: #9b59b6 !important;
            min-width: 100px;
            text-align: center;
        }

        .verify-desc {
            font-weight: 500;
            color: #2c3e50;
        }

        .verify-input {
            font-family: 'Courier New', monospace;
            color: #2980b9;
            background-color: #ebf5fb;
        }

        .verify-output {
            font-family: 'Courier New', monospace;
            color: #27ae60;
            background-color: #eafaf1;
        }

        .verify-status {
            text-align: center;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 12px;
        }

        .status-passed {
            background-color: #2ecc71;
            color: white;
        }

        .status-failed {
            background-color: #e74c3c;
            color: white;
        }

        .no-tests {
            color: #95a5a6;
            font-style: italic;
            padding: 15px;
            text-align: center;
            background: #ecf0f1;
            border-radius: 6px;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .back-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }

        .back-button:hover {
            background: #2980b9;
        }

        /* Tree visualization styles */
        .expression-tree {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            background: white;
            padding: 15px;
            border-radius: 6px;
            text-align: left;
        }

        .tree-node {
            margin: 4px 0;
            display: flex;
            align-items: flex-start;
        }

        .tree-connector {
            color: #95a5a6;
            margin-right: 5px;
            flex-shrink: 0;
        }

        .tree-icon {
            margin-right: 5px;
            flex-shrink: 0;
        }

        .tree-label {
            color: #8e44ad;
            font-weight: 600;
            margin-right: 5px;
        }

        .tree-content {
            color: #2c3e50;
            flex: 1;
        }

        .tree-children {
            margin-left: 20px;
            border-left: 2px solid #ecf0f1;
            padding-left: 10px;
        }

        .literal {
            color: #27ae60;
            font-weight: 500;
        }

        .string-literal {
            color: #e67e22;
        }

        .number-literal {
            color: #3498db;
        }

        .bool-literal {
            color: #9b59b6;
        }

        .variable {
            color: #2980b9;
            font-weight: 500;
        }

        .operation {
            color: #c0392b;
            font-weight: 600;
        }

        .keyword {
            color: #8e44ad;
            font-weight: 600;
        }

        .tree-line {
            margin: 2px 0;
        }

        .nested-structure {
            margin-left: 15px;
            padding-left: 10px;
            border-left: 2px solid #3498db;
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="app">
            <div class="header">
                <h1>üîß Franka Module Browser</h1>
                <p>Browse and explore Franka modules and their test cases</p>
            </div>
            <div id="content" class="loading">Loading...</div>
        </div>
    </div>

    <script>
        // State management
        let state = {
            currentPath: '',
            view: 'directory',
            directoryData: null,
            moduleData: null,
            loading: true,
            error: null
        };

        // Utility function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Format values for display
        function formatValue(value) {
            if (typeof value === 'object' && value !== null) {
                return JSON.stringify(value, null, 2);
            }
            return String(value);
        }

        // Render expression as a tree-like HTML structure
        function renderExpressionTree(expr, indent = 0) {
            if (expr === null || expr === undefined) {
                return '<span class="literal">null</span>';
            }

            // Handle primitives (strings, numbers, booleans)
            if (typeof expr === 'string') {
                return `<span class="literal string-literal">"${escapeHtml(expr)}"</span>`;
            }
            if (typeof expr === 'number') {
                return `<span class="literal number-literal">${expr}</span>`;
            }
            if (typeof expr === 'boolean') {
                return `<span class="literal bool-literal">${expr}</span>`;
            }

            // Handle arrays
            if (Array.isArray(expr)) {
                if (expr.length === 0) {
                    return '<span class="literal">[]</span>';
                }
                let html = '';
                expr.forEach((item, index) => {
                    html += '<div class="tree-node">';
                    html += `<span class="tree-connector">${index === expr.length - 1 ? '‚îî‚îÄ' : '‚îú‚îÄ'}</span>`;
                    html += renderExpressionTree(item, indent + 1);
                    html += '</div>';
                });
                return html;
            }

            // Handle objects
            if (typeof expr === 'object') {
                const keys = Object.keys(expr);
                if (keys.length === 0) {
                    return '<span class="literal">{}</span>';
                }

                // Special handling for specific operations
                if (keys.length === 1) {
                    const key = keys[0];
                    const value = expr[key];

                    // Handle 'get' operation
                    if (key === 'get') {
                        return `<span class="keyword">get</span> <span class="variable">${escapeHtml(value)}</span>`;
                    }

                    // Handle 'let/in' structure
                    if (key === 'let' && typeof value === 'object' && !Array.isArray(value)) {
                        let html = '<div class="tree-node"><span class="keyword">let</span></div>';
                        html += '<div class="nested-structure">';
                        Object.entries(value).forEach(([bindName, bindValue], index, arr) => {
                            html += '<div class="tree-line">';
                            html += `<span class="tree-connector">${index === arr.length - 1 ? '‚îî‚îÄ' : '‚îú‚îÄ'}</span>`;
                            html += `<span class="variable">${escapeHtml(bindName)}</span> = `;
                            html += renderExpressionTree(bindValue, indent + 1);
                            html += '</div>';
                        });
                        html += '</div>';
                        return html;
                    }

                    if (key === 'in') {
                        let html = '<div class="tree-node"><span class="keyword">in</span></div>';
                        html += '<div class="nested-structure">';
                        html += renderExpressionTree(value, indent + 1);
                        html += '</div>';
                        return html;
                    }

                    // Handle 'if/then/else' structure
                    if (key === 'if') {
                        let html = '<div class="tree-node">';
                        html += '<span class="tree-icon">üîÄ</span>';
                        html += '<span class="keyword">if</span> ';
                        html += renderExpressionTree(value, indent + 1);
                        html += '</div>';
                        return html;
                    }

                    if (key === 'then') {
                        let html = '<div class="tree-node">';
                        html += '<span class="tree-connector">‚îú‚îÄ</span>';
                        html += '<span class="tree-icon">‚úì</span>';
                        html += '<span class="keyword">then:</span>';
                        html += '</div>';
                        html += '<div class="nested-structure">';
                        html += renderExpressionTree(value, indent + 1);
                        html += '</div>';
                        return html;
                    }

                    if (key === 'else') {
                        let html = '<div class="tree-node">';
                        html += '<span class="tree-connector">‚îî‚îÄ</span>';
                        html += '<span class="tree-icon">‚úó</span>';
                        html += '<span class="keyword">else:</span>';
                        html += '</div>';
                        html += '<div class="nested-structure">';
                        html += renderExpressionTree(value, indent + 1);
                        html += '</div>';
                        return html;
                    }

                    // Handle operations with single arguments
                    if (['uppercase', 'lowercase', 'not'].includes(key)) {
                        let html = '<span class="operation">' + escapeHtml(key) + '</span>(';
                        html += renderExpressionTree(value, indent);
                        html += ')';
                        return html;
                    }
                }

                // Handle binary operations
                if (keys.includes('left') && keys.includes('right')) {
                    const operation = keys.find(k => k !== 'left' && k !== 'right');
                    if (operation) {
                        let html = '<div class="tree-node">';
                        html += `<span class="tree-icon">‚ö°</span>`;
                        html += `<span class="operation">${escapeHtml(operation)}</span>`;
                        html += '</div>';
                        html += '<div class="nested-structure">';
                        html += '<div class="tree-line">';
                        html += '<span class="tree-connector">‚îú‚îÄ</span>';
                        html += '<span class="tree-label">left:</span> ';
                        html += renderExpressionTree(expr.left, indent + 1);
                        html += '</div>';
                        html += '<div class="tree-line">';
                        html += '<span class="tree-connector">‚îî‚îÄ</span>';
                        html += '<span class="tree-label">right:</span> ';
                        html += renderExpressionTree(expr.right, indent + 1);
                        html += '</div>';
                        html += '</div>';
                        return html;
                    }
                }

                // Handle concat operation
                if (keys.length === 1 && keys[0] === 'concat' && Array.isArray(expr.concat)) {
                    let html = '<div class="tree-node">';
                    html += '<span class="tree-icon">üîó</span>';
                    html += '<span class="operation">concat</span>';
                    html += '</div>';
                    html += '<div class="nested-structure">';
                    expr.concat.forEach((item, index) => {
                        html += '<div class="tree-line">';
                        html += `<span class="tree-connector">${index === expr.concat.length - 1 ? '‚îî‚îÄ' : '‚îú‚îÄ'}</span>`;
                        html += renderExpressionTree(item, indent + 1);
                        html += '</div>';
                    });
                    html += '</div>';
                    return html;
                }

                // Generic object rendering
                let html = '<div class="tree-children">';
                keys.forEach((key, index) => {
                    html += '<div class="tree-line">';
                    html += `<span class="tree-connector">${index === keys.length - 1 ? '‚îî‚îÄ' : '‚îú‚îÄ'}</span>`;
                    html += `<span class="tree-label">${escapeHtml(key)}:</span> `;
                    html += renderExpressionTree(expr[key], indent + 1);
                    html += '</div>';
                });
                html += '</div>';
                return html;
            }

            return escapeHtml(String(expr));
        }

        // Render functions
        function render() {
            const content = document.getElementById('content');
            
            if (state.view === 'directory') {
                renderDirectory(content);
            } else if (state.view === 'module') {
                renderModule(content);
            }
        }

        function renderDirectory(container) {
            if (state.loading) {
                container.innerHTML = '<div class="loading">Loading directory...</div>';
                return;
            }

            if (state.error) {
                container.innerHTML = `<div class="error">Error: ${escapeHtml(state.error)}</div>`;
                return;
            }

            if (!state.directoryData) {
                return;
            }

            const pathParts = state.currentPath ? state.currentPath.split('/').filter(Boolean) : [];
            
            let breadcrumbHtml = '<div class="breadcrumb">';
            breadcrumbHtml += '<a href="#" data-path="">üè† Home</a>';
            pathParts.forEach((part, index) => {
                const path = pathParts.slice(0, index + 1).join('/');
                breadcrumbHtml += `<span>/</span><a href="#" data-path="${escapeHtml(path)}">${escapeHtml(part)}</a>`;
            });
            breadcrumbHtml += '</div>';

            let listHtml = '<div class="directory-list">';
            if (state.directoryData.entries.length === 0) {
                listHtml += '<div class="directory-item disabled"><span class="item-name">No modules or directories found</span></div>';
            } else {
                state.directoryData.entries.forEach(item => {
                    const icon = item.type === 'directory' ? 'üìÅ' : 'üìÑ';
                    listHtml += `<div class="directory-item" data-type="${item.type}" data-path="${escapeHtml(item.path)}">`;
                    listHtml += `<span class="item-icon">${icon}</span>`;
                    listHtml += `<span class="item-name">${escapeHtml(item.name)}</span>`;
                    listHtml += '</div>';
                });
            }
            listHtml += '</div>';

            container.innerHTML = breadcrumbHtml + listHtml;

            // Add event listeners
            container.querySelectorAll('.breadcrumb a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const path = e.target.dataset.path;
                    navigateTo(path);
                });
            });

            container.querySelectorAll('.directory-item:not(.disabled)').forEach(item => {
                item.addEventListener('click', () => {
                    const type = item.dataset.type;
                    const path = item.dataset.path;
                    if (type === 'directory') {
                        navigateTo(path);
                    } else if (type === 'file') {
                        loadModule(path);
                    }
                });
            });
        }

        function renderModule(container) {
            if (state.loading) {
                container.innerHTML = '<div class="loading">Loading module...</div>';
                return;
            }

            if (state.error) {
                const html = `
                    <button class="back-button" onclick="backToDirectory()">‚Üê Back to Directory</button>
                    <div class="error">Error: ${escapeHtml(state.error)}</div>
                `;
                container.innerHTML = html;
                return;
            }

            if (!state.moduleData) {
                return;
            }

            const { module, specs } = state.moduleData;

            let html = '<button class="back-button" onclick="backToDirectory()">‚Üê Back to Directory</button>';
            html += '<div class="module-view">';
            html += '<div class="module-header">';
            html += `<h2>${escapeHtml(module.module.name)}</h2>`;
            if (module.module.description) {
                html += `<p class="description">${escapeHtml(module.module.description)}</p>`;
            }
            html += '</div>';

            html += '<div class="function-section"><h3>Functions</h3>';
            Object.entries(module.functions).forEach(([funcName, funcDef]) => {
                const tests = specs?.functions[funcName]?.tests || [];
                html += renderFunctionCard(funcName, funcDef, tests);
            });
            html += '</div>';

            html += '</div>';

            container.innerHTML = html;
        }

        function renderInputOutputGrid(input, output) {
            let html = '<div class="io-container">';
            
            // Render Input section
            html += '<div class="io-section">';
            html += '<h4>Input</h4>';
            if (input) {
                html += '<table class="io-grid">';
                html += '<thead><tr><th>Name</th><th>Type</th><th>Default</th></tr></thead>';
                html += '<tbody>';
                Object.entries(input).forEach(([paramName, paramDef]) => {
                    html += '<tr>';
                    html += `<td class="param-name">${escapeHtml(paramName)}</td>`;
                    html += `<td class="param-type">${escapeHtml(paramDef.type || '-')}</td>`;
                    html += `<td class="param-default">${paramDef.default !== undefined ? escapeHtml(String(paramDef.default)) : '-'}</td>`;
                    html += '</tr>';
                });
                html += '</tbody></table>';
            } else {
                html += '<div class="not-declared">Not declared</div>';
            }
            html += '</div>';
            
            // Arrow
            html += '<div class="io-arrow">‚Üí</div>';
            
            // Render Output section
            html += '<div class="io-section">';
            html += '<h4>Output</h4>';
            if (output) {
                // Check if it's a single unnamed output (has 'type' property directly)
                if (output.type) {
                    html += '<table class="io-grid">';
                    html += '<thead><tr><th>Name</th><th>Type</th></tr></thead>';
                    html += '<tbody>';
                    html += '<tr>';
                    html += `<td class="param-name">(return value)</td>`;
                    html += `<td class="param-type">${escapeHtml(output.type)}</td>`;
                    html += '</tr>';
                    html += '</tbody></table>';
                } else {
                    // Multiple named outputs
                    html += '<table class="io-grid">';
                    html += '<thead><tr><th>Name</th><th>Type</th></tr></thead>';
                    html += '<tbody>';
                    Object.entries(output).forEach(([outputName, outputDef]) => {
                        html += '<tr>';
                        html += `<td class="param-name">${escapeHtml(outputName)}</td>`;
                        html += `<td class="param-type">${escapeHtml(outputDef.type || '-')}</td>`;
                        html += '</tr>';
                    });
                    html += '</tbody></table>';
                }
            } else {
                html += '<div class="not-declared">Not declared</div>';
            }
            html += '</div>';
            
            html += '</div>';
            return html;
        }

        function renderVerificationGrid(funcName, func, tests) {
            let html = '<div class="verification-section">';
            html += '<h4>üîç Verification</h4>';
            
            if (tests.length === 0) {
                html += '<div class="no-tests">No test cases defined</div>';
                html += '</div>';
                return html;
            }

            // Build column structure
            const inputParams = func.input ? Object.keys(func.input) : [];
            const outputParams = getOutputParams(func.output);

            html += '<div class="verification-grid-container">';
            html += '<table class="verification-grid">';
            
            // Header row
            html += '<thead><tr>';
            html += '<th class="verify-desc-col">Description</th>';
            
            // Input parameter columns
            inputParams.forEach(param => {
                html += `<th class="verify-input-col">${escapeHtml(param)}</th>`;
            });
            
            // Output parameter columns
            outputParams.forEach(param => {
                html += `<th class="verify-output-col">${escapeHtml(param)}</th>`;
            });
            
            html += '<th class="verify-status-col">Status</th>';
            html += '</tr></thead>';
            
            // Test case rows
            html += '<tbody>';
            tests.forEach((test, index) => {
                html += '<tr>';
                
                // Description
                html += `<td class="verify-desc">${escapeHtml(test.description || `Test ${index + 1}`)}</td>`;
                
                // Input values
                inputParams.forEach(param => {
                    const value = test.input && test.input[param] !== undefined 
                        ? test.input[param] 
                        : (func.input[param].default !== undefined ? func.input[param].default : '-');
                    html += `<td class="verify-input">${escapeHtml(formatValue(value))}</td>`;
                });
                
                // Expected output values
                outputParams.forEach(param => {
                    const value = test.expectedOutput && test.expectedOutput[param] !== undefined 
                        ? test.expectedOutput[param] 
                        : test.expectedOutput;
                    html += `<td class="verify-output">${escapeHtml(formatValue(value))}</td>`;
                });
                
                // Status - we'll mark as passed for now (would need actual execution to determine)
                html += '<td class="verify-status"><span class="status-badge status-passed">‚úì Passed</span></td>';
                html += '</tr>';
            });
            html += '</tbody>';
            
            html += '</table>';
            html += '</div>';
            html += '</div>';
            return html;
        }

        function getOutputParams(output) {
            if (!output) {
                return ['result'];
            }
            // Check if it's a single unnamed output (has 'type' property directly)
            if (output.type) {
                return ['result'];
            }
            // Multiple named outputs
            return Object.keys(output);
        }

        function renderFunctionCard(name, func, tests) {
            let html = '<div class="function-card">';
            html += '<div class="function-header">';
            html += `<div class="function-name">‚öôÔ∏è ${escapeHtml(name)}</div>`;
            html += '</div>';

            if (func.description) {
                html += `<div class="function-description">${escapeHtml(func.description)}</div>`;
            }

            // Input/Output at the top
            html += renderInputOutputGrid(func.input, func.output);

            html += '<div class="function-details">';
            html += '<h4>Logic</h4>';
            html += `<div class="expression-tree">${renderExpressionTree(func.logic)}</div>`;
            html += '</div>';

            // Render verification grid
            html += renderVerificationGrid(name, func, tests);

            html += '</div>';
            return html;
        }

        // API functions
        async function loadDirectory(path) {
            state.loading = true;
            state.error = null;
            render();

            try {
                const response = await fetch(`/api/browse?path=${encodeURIComponent(path)}`);
                if (!response.ok) {
                    throw new Error('Failed to load directory');
                }
                state.directoryData = await response.json();
            } catch (err) {
                state.error = err.message;
            } finally {
                state.loading = false;
                render();
            }
        }

        async function loadModule(path) {
            state.loading = true;
            state.error = null;
            state.view = 'module';
            // Update URL hash
            window.location.hash = `#/module/${path}`;
            render();

            try {
                const response = await fetch(`/api/module?path=${encodeURIComponent(path)}`);
                if (!response.ok) {
                    throw new Error('Failed to load module');
                }
                state.moduleData = await response.json();
            } catch (err) {
                state.error = err.message;
            } finally {
                state.loading = false;
                render();
            }
        }

        function navigateTo(path) {
            state.currentPath = path;
            state.view = 'directory';
            // Update URL hash
            window.location.hash = path ? `#/browse/${path}` : '#/';
            loadDirectory(path);
        }

        function backToDirectory() {
            state.view = 'directory';
            state.moduleData = null;
            // Update URL hash to current path
            window.location.hash = state.currentPath ? `#/browse/${state.currentPath}` : '#/';
            render();
        }

        // Parse URL hash and return view state
        function parseHash() {
            const hash = window.location.hash.slice(1); // Remove leading #
            
            if (!hash || hash === '/') {
                return { view: 'directory', path: '' };
            }
            
            if (hash.startsWith('/browse/')) {
                const path = hash.slice(8); // Remove '/browse/'
                return { view: 'directory', path: path };
            }
            
            if (hash.startsWith('/module/')) {
                const path = hash.slice(8); // Remove '/module/'
                return { view: 'module', path: path };
            }
            
            // Default to home if hash is unrecognized
            return { view: 'directory', path: '' };
        }

        // Handle browser back/forward buttons
        window.addEventListener('hashchange', () => {
            const parsed = parseHash();
            
            if (parsed.view === 'directory') {
                state.currentPath = parsed.path;
                state.view = 'directory';
                loadDirectory(parsed.path);
            } else if (parsed.view === 'module') {
                loadModule(parsed.path);
            }
        });

        // Initialize from URL hash
        function initialize() {
            const parsed = parseHash();
            
            if (parsed.view === 'directory') {
                state.currentPath = parsed.path;
                state.view = 'directory';
                loadDirectory(parsed.path);
            } else if (parsed.view === 'module') {
                state.currentPath = parsed.path.split('/').slice(0, -1).join('/');
                loadModule(parsed.path);
            }
        }

        initialize();
    </script>
</body>
</html>
